# Authentication & Authorization

This document explains how OSAC UI handles authentication and authorization using Keycloak and OpenID Connect (OIDC).

## Overview

OSAC UI uses enterprise-grade authentication with the following components:

- **Keycloak**: Identity and access management server
- **OIDC (OpenID Connect)**: Industry-standard authentication protocol
- **PKCE**: Proof Key for Code Exchange for enhanced security
- **JWT Tokens**: JSON Web Tokens for stateless authentication
- **Role-Based Access Control**: Admin and client roles
- **Multi-Tenant Organizations**: Group-based organization isolation

## Authentication Flow

### 1. Authorization Code Flow with PKCE

```
┌──────────┐                                  ┌──────────┐
│  User    │                                  │ OSAC UI  │
│ Browser  │                                  │  (SPA)   │
└────┬─────┘                                  └────┬─────┘
     │                                             │
     │  1. Access Application                      │
     ├────────────────────────────────────────────>│
     │                                             │
     │  2. Redirect to Keycloak Login              │
     │<────────────────────────────────────────────┤
     │                                             │
┌────▼─────┐                                       │
│ Keycloak │                                       │
│  Server  │                                       │
└────┬─────┘                                       │
     │                                             │
     │  3. User enters credentials                 │
     │  4. Keycloak validates user                 │
     │                                             │
     │  5. Redirect to callback with auth code     │
     ├─────────────────────────────────────────────>
     │                                             │
     │  6. Exchange code for tokens (PKCE)         │
     │<────────────────────────────────────────────┤
     │                                             │
     │  7. Return access token, ID token, refresh  │
     ├─────────────────────────────────────────────>
     │                                             │
     │  8. Store tokens, navigate to dashboard     │
     │                                             │
```

### 2. PKCE (Proof Key for Code Exchange)

OSAC UI implements PKCE for enhanced security:

1. **Code Verifier**: Random string generated by the client
2. **Code Challenge**: SHA-256 hash of the code verifier
3. **Authorization Request**: Sends code challenge to Keycloak
4. **Token Exchange**: Sends code verifier to prove authenticity

This prevents authorization code interception attacks.

## Keycloak Configuration

### Realm Setup

Create an `innabox` realm in Keycloak with the following configuration:

**Realm Settings:**
- Name: `innabox`
- Enabled: Yes
- User Registration: As needed
- Email as Username: Optional
- Login with Email: Optional

### Client Configuration

Create an OIDC client for OSAC UI:

**Basic Settings:**
```
Client ID: osac-ui
Name: OSAC UI
Description: OSAC UI Web Console
Client Type: Public
```

**Capability Config:**
```
Standard Flow: Enabled
Direct Access Grants: Disabled
Implicit Flow: Disabled
```

**Authentication Flow:**
```
Root URL: https://osac-ui.<namespace>.<cluster-domain>
Valid Redirect URIs:
  - https://osac-ui.<namespace>.<cluster-domain>/*
  - http://localhost:3000/*
  - http://localhost:5173/*
  - http://localhost:8080/*

Valid Post Logout Redirect URIs:
  - https://osac-ui.<namespace>.<cluster-domain>
  - http://localhost:3000
  - http://localhost:5173
  - http://localhost:8080

Web Origins:
  - https://osac-ui.<namespace>.<cluster-domain>
  - http://localhost:3000
  - http://localhost:5173
  - http://localhost:8080
```

**Advanced Settings:**
```
PKCE Code Challenge Method: S256
Access Token Lifespan: 5 minutes
SSO Session Idle: 30 minutes
SSO Session Max: 10 hours
```

### Client Scopes

Add the `groups` scope to the client's default scopes:

1. Go to **Client Scopes** tab
2. Add `groups` to **Default Client Scopes**
3. Add `roles` to **Default Client Scopes**

This ensures group membership is included in tokens.

### Automated Setup

Use the provided script to configure Keycloak:

```bash
# For development environment
cd scripts
./configure-keycloak.sh

# For integration environment
./configure-keycloak-integration.sh
```

## Roles and Permissions

### Role Definitions

OSAC UI supports two main roles:

#### 1. `fulfillment-admin`
- Full access to all features
- Can create, modify, and delete resources
- Access to admin-only pages (Templates, Cluster Catalog)
- Can manage all organizations

**How to grant:**
- Add user to `/admins` group in Keycloak, OR
- Assign `organization-admin` role to the user

#### 2. `fulfillment-client`
- Standard user access
- Can view and manage own resources
- Limited to assigned organization(s)
- Cannot access admin features

**How to grant:**
- Default role for all authenticated users
- Automatically assigned if not in admin group

### Role Assignment in Code

The role is determined in `AuthContext.tsx`:

```typescript
const groups = (user?.profile?.groups as string[]) || []
const allRoles = [...realmRoles, ...resourceRoles, ...directRoles]

const role = (groups.includes('/admins') || allRoles.includes('organization-admin'))
  ? 'fulfillment-admin'
  : 'fulfillment-client'
```

## Multi-Tenant Organizations

### Group-Based Organizations

Organizations are implemented using Keycloak groups:

**Group Structure:**
```
/organizations
  /org1
    - user1
    - user2
  /org2
    - user3
    - user4
/admins
  - admin1
  - admin2
```

### Organization Claims

Groups are included in the JWT token via the `groups` client scope:

```json
{
  "groups": [
    "/organizations/org1",
    "/admins"
  ]
}
```

The UI extracts organizations from the groups claim:

```typescript
const groups = (user?.profile?.groups as string[]) || []
const organizations = (user?.profile?.organizations as string[]) || groups
```

### Organization Filtering

Resources are filtered by organization:
- Admins see all resources
- Regular users see only resources in their organization(s)

## Token Management

### Token Storage

Tokens are stored in browser localStorage:

```typescript
// Storage key
localStorage.setItem('osac_ui_token', user.access_token)

// Retrieval
const token = localStorage.getItem('osac_ui_token')
```

### Automatic Token Refresh

The OIDC client handles automatic token refresh:

**Configuration:**
```typescript
{
  automaticSilentRenew: true,
  silent_redirect_uri: `${CONSOLE_URL}/silent-renew.html`,
  accessTokenExpiringNotificationTimeInSeconds: 60
}
```

**Silent Renew Process:**
1. Token expiration detected (60 seconds before expiry)
2. Hidden iframe loads `silent-renew.html`
3. Keycloak session validates and issues new token
4. New token stored and applied to requests

### Token Validation

All API requests include the access token:

```typescript
axios.interceptors.request.use((config) => {
  const token = localStorage.getItem('osac_ui_token')
  if (token) {
    config.headers.Authorization = `Bearer ${token}`
  }
  return config
})
```

## OIDC Configuration

### Runtime Configuration

OIDC settings are loaded dynamically from the server:

**Server-side** (`server/index.js`):
```javascript
app.get('/api/config', (req, res) => {
  res.json({
    fulfillmentApiUrl: process.env.FULFILLMENT_API_URL,
    keycloakUrl: process.env.KEYCLOAK_URL,
    keycloakRealm: process.env.KEYCLOAK_REALM,
    oidcClientId: process.env.OIDC_CLIENT_ID
  })
})
```

**Client-side** (`src/auth/oidcConfig.ts`):
```typescript
export async function loadConfig() {
  const config = await getConfig()
  return {
    authority: `${config.keycloakUrl}/realms/${config.keycloakRealm}`,
    client_id: config.oidcClientId,
    redirect_uri: `${window.location.origin}/callback`,
    // ... other OIDC settings
  }
}
```

### OIDC Endpoints

Keycloak provides standard OIDC endpoints:

```
Authorization: /realms/{realm}/protocol/openid-connect/auth
Token:         /realms/{realm}/protocol/openid-connect/token
UserInfo:      /realms/{realm}/protocol/openid-connect/userinfo
Logout:        /realms/{realm}/protocol/openid-connect/logout
JWKS:          /realms/{realm}/protocol/openid-connect/certs
```

## Security Best Practices

### 1. PKCE Implementation

Always use PKCE for public clients (SPAs):

```typescript
{
  code_challenge_method: 'S256' as const
}
```

### 2. Token Security

- Store tokens in localStorage (acceptable for SPAs with proper CORS)
- Never expose refresh tokens in browser console
- Clear tokens on logout
- Implement token expiration handling

### 3. CORS Configuration

Keycloak must allow the UI origin:

```
Valid Redirect URIs: https://osac-ui.example.com/*
Web Origins: https://osac-ui.example.com
```

### 4. HTTPS Only

Always use HTTPS in production:
- Keycloak server: `https://`
- OSAC UI: `https://`
- API endpoints: `https://`

### 5. Session Security

Configure appropriate session timeouts:
- Access Token: 5 minutes
- SSO Session Idle: 30 minutes
- SSO Session Max: 10 hours

## User Management

### Creating Users

**Via Keycloak Admin Console:**
1. Go to Users → Add User
2. Set username, email, first/last name
3. Set temporary password in Credentials tab
4. Add to appropriate groups (Organizations, Admins)

**Via Keycloak REST API:**
```bash
curl -X POST "https://keycloak.example.com/admin/realms/innabox/users" \
  -H "Authorization: Bearer $ADMIN_TOKEN" \
  -H "Content-Type: application/json" \
  -d '{
    "username": "john.doe",
    "email": "john.doe@example.com",
    "firstName": "John",
    "lastName": "Doe",
    "enabled": true,
    "groups": ["/organizations/org1"]
  }'
```

### Managing Groups

**Create Organization:**
```bash
curl -X POST "https://keycloak.example.com/admin/realms/innabox/groups" \
  -H "Authorization: Bearer $ADMIN_TOKEN" \
  -H "Content-Type: application/json" \
  -d '{
    "name": "org1",
    "path": "/organizations/org1"
  }'
```

**Add User to Group:**
```bash
curl -X PUT \
  "https://keycloak.example.com/admin/realms/innabox/users/$USER_ID/groups/$GROUP_ID" \
  -H "Authorization: Bearer $ADMIN_TOKEN"
```

## Troubleshooting

### Login Redirect Loop

**Symptom:** User redirects back to login after successful authentication

**Solutions:**
- Verify `Valid Redirect URIs` includes the callback URL
- Check browser console for CORS errors
- Verify OIDC client ID matches configuration
- Clear browser localStorage and cookies

### Token Not Included in Requests

**Symptom:** API returns 401 Unauthorized

**Solutions:**
- Check token is stored in localStorage
- Verify Axios interceptor is configured
- Check token hasn't expired
- Verify CORS headers allow Authorization header

### Groups Not in Token

**Symptom:** User assigned to groups but they don't appear in claims

**Solutions:**
- Add `groups` to client's default scopes
- Verify group mapper is configured correctly
- Check token in browser console: `JSON.parse(atob(token.split('.')[1]))`

### Silent Renew Failures

**Symptom:** User logged out after token expires

**Solutions:**
- Verify `silent-renew.html` exists in public folder
- Check Keycloak session is still valid
- Verify `silent_redirect_uri` is in Valid Redirect URIs
- Check browser console for iframe errors

## Development vs Production

### Development Configuration

```typescript
{
  redirect_uri: 'http://localhost:5173/callback',
  post_logout_redirect_uri: 'http://localhost:5173/',
}
```

### Production Configuration

```typescript
{
  redirect_uri: 'https://osac-ui.example.com/callback',
  post_logout_redirect_uri: 'https://osac-ui.example.com/',
}
```

The application dynamically determines URLs based on `window.location.origin`.
